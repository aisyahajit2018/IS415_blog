---
title: "Hands-on Exercise 2"
description: |
  In this hands-on exercise, I learn how to handle geospatial data in R by using sf package and performing data science tasks using tidyverse package.
author:
  - name: Nor Aisyah
    url: https://www.linkedin.com/in/nor-aisyah/
date: 08-26-2021
output:
  distill::distill_article:
    self_contained: false
    toc: TRUE
    toc_depth: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# 1. Getting Started  


This code chunk performs 3 tasks:
- A list called packages will be created and will consists of all the R packages required to accomplish this hands-on exercise.
- Check if R packages on package have been installed in R and if not, they will be installed.
- After all the R packages have been installed, they will be loaded.  


```{r echo=TRUE, eval=TRUE}
packages = c('sf', 'tidyverse')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

## 1.1 My own notes: 
a. More about packages used:
- **sf**: used for importing, managing, and processing **geospatial** data
- **tidyverse**: used for importing, wrangling and visualising data. It consists of a family of R packages, such as:
  - readr for importing csv data,
  - readxl for importing Excel worksheet,
  - tidyr for manipulating data,
  - dplyr for transforming data, and
  - ggplot2 for visualising data

# 2. Importing Geospatial Data
Data used:
- MP14_SUBZONE_WEB_PL, a **polygon** feature layer in ESRI shapefile format,
- CyclingPath, a **line** feature layer in ESRI shapefile format, and
- PreSchool, a **point** feature layer in kml file format.

## 2.1 Importing **polygon** feature data in shapefile format
```{r echo=TRUE, eval=TRUE}
mpsz = st_read(dsn = "data/geospatial", layer = "MP14_SUBZONE_WEB_PL")
```

- From the results above we can see that:
  - there are **323 multipolygon features and 15 fields** in the sf data frame. 
  - **svy21** is the projected coordinates system
  
## 2.2 Importing **polyline** feature data in shapefile form
```{r echo=TRUE, eval=TRUE}
cyclingpath = st_read(dsn = "data/geospatial", layer = "CyclingPath")

```

- From the results above we can see that:
  - there are **3336  multipolygon features and 2 fields** in the sf data frame. 
  - **svy21** is the projected coordinates system
  
## 2.3 Importing **GIS/Line** data in kml format
```{r echo=TRUE, eval=TRUE}
preschool = st_read("data/geospatial/pre-schools-location-kml.kml")
```

## 2.4 My own notes: 
a. Difference between Polyline and Polygon : 
- Polyline geometries are made up of two or more vertices forming a connected line.
- Polygon geometries are made up of at least four vertices forming an enclosed area. The first and last vertices are always in the same place.

b. Both **mpsz** and **cycling** path have **svy21** as the projected coordinates systems. 

c. Only **preschool** have **wgs84** as the projected coordinates systems. 
- We need to assign the correct one later

# 3. Checking the Content of A Simple Feature Data Frame

## 3.1 **st_geometry()** function
- Column in the sf data.frame that contains the geometries is a list of class sfc. 
- We can retrieve the geometry list-column like this:

```{r echo=TRUE, eval=TRUE}
mpsz$geometry
```

- But the more general way is:

```{r echo=TRUE, eval=TRUE}
st_geometry(mpsz)
```

## 3.2 **glimpse()** function
- glimpse function belongs to dplyr package.
- glimpse will show the 
   - No. of rows and columns, 
   - Column Names found,
   - Data types of each field and 
   - A few samples of the data

```{r echo=TRUE, eval=TRUE}
glimpse(mpsz)
```

## 3.3 **head()** function
- head function belongs to Base R package.
- we can limit the no. of records to display by specifying the number for n
- head will show the complete information of a feature object:
  - No. of fields (columns)
  - No. of features (rows)
  - Other information like: geometry type, dimension, bounding box, projected crs
  
```{r echo=TRUE, eval=TRUE}
head(mpsz, n=5)  
```


# 4.Plotting the Geospatial Data

## 4.1 **plot()** function
- Plot the **geometry** map outline

```{r echo=TRUE, eval=TRUE}
plot(st_geometry(mpsz))
```

- Plot everything 

```{r echo=TRUE, eval=TRUE}
plot(mpsz)
```

- Plot a **specific attribute**

```{r echo=TRUE, eval=TRUE}
plot(mpsz["PLN_AREA_N"])
```


# 5. Working with Projection

**Projection transformation**: Project a simple feature data frame from one coordinate system to another coordinate system

## 5.1 Assigning EPSG code to a simple feature data frame

### 5.1.1 Retrieve coordinate reference system from object using **st_crs** function
```{r echo=TRUE, eval=TRUE}
st_crs(mpsz)
```

### 5.1.2 Assign correct EPSG code
- mpsz is projected in svy21 but the EPSG is 9001
- Must set it to 3414 before proceeding

```{r echo=TRUE, eval=TRUE}
mpsz3414 <- st_set_crs(mpsz, 3414)
```

### 5.1.3 Check CSR again
```{r echo=TRUE, eval=TRUE}
st_crs(mpsz3414)
```

### 5.1.4 Transform the original data from geographic coordinate system to *projected* coordinate system.
```{r echo=TRUE, eval=TRUE}
preschool3414 <- st_transform(preschool, crs = 3414)
st_geometry(preschool3414)
```


# 6. Importing and Converting An Aspatial Data

```{r echo=TRUE, eval=TRUE}
listings <- read_csv("data/aspatial/listings.csv")
```

## 6.1 View data using glimpse vs list

### 6.1.1 glimpse()
```{r echo=TRUE, eval=TRUE}
glimpse(listings) 
```

### 6.1.2 **list()**
```{r echo=TRUE, eval=TRUE}
list(listings) 
```

## 6.2 Create a simple feature data frame from an aspatial data frame
- Arguments of **st_as_sf**:
  - coords: Provide column name of  x-coordinates followed by  column name of y-coordinates
  - crs: provide the coordinates system in epsg format
- %>% is used to nest **st_transform() **
  - *st_transform*: transform newly created simple feature data frame into *3414* projected coordinates system
  
```{r echo=TRUE, eval=TRUE}
listings_sf <- st_as_sf(listings, 
                       coords = c("longitude", "latitude"),
                       crs=4326) %>% st_transform(crs = 3414)
```


```{r echo=TRUE, eval=TRUE}
glimpse(listings_sf) 
```


# 7. Geoprocessing with sf package

Task on hand: Determine the extend of the land need to be acquired and their total area

## 7.1 Buffer

### 7.1.1 Compute the 5-meter buffers around cycling paths using st_buffer
- Why 5 meters? As authority wants to upgrade the exiting cycling path hence they need to acquire 5 metres of reserved land on the both sides of the current cycling path.

```{r echo=TRUE, eval=TRUE}
buffer_cycling <- st_buffer(cyclingpath, dist=5, nQuadSegs = 30)
```

### 7.1.2 Calculate area of the buffers 
```{r echo=TRUE, eval=TRUE}
buffer_cycling$AREA <- st_area(buffer_cycling)
```

### 7.1.3 Derive the total land involved with sum()
```{r echo=TRUE, eval=TRUE}
sum(buffer_cycling$AREA)
```


# 8. Point-in-polygon count

# 8.1 Find no. of preschools in each Planning Subzone
- Identify pre-schools located inside each Planning Subzone using **st_intersects()**. 
- Calculate numbers of pre-schools that fall inside each planning subzone using **length()** of Base R  

```{r echo=TRUE, eval=TRUE}
mpsz3414$`PreSch Count`<- lengths(st_intersects(mpsz3414, preschool3414))
summary(mpsz3414$`PreSch Count`)
```

## 8.2 List planning subzone with most number of pre-school using **top_n()**
```{r echo=TRUE, eval=TRUE}
top_n(mpsz3414, 1, `PreSch Count`)
```

## 8.3 Calculate density of pre-school by planning subzone.

### 8.3.1 Derive area of each planning subzone using **st_area()** of sf package first
```{r echo=TRUE, eval=TRUE}
mpsz3414$Area <- mpsz3414 %>% st_area()
```

### 8.3.2 Compute the density using **mutate()** of dplyr
- We multiple it by 1,000,000 to show in km^2

```{r echo=TRUE, eval=TRUE}
mpsz3414 <- mpsz3414 %>%
  mutate(`PreSch Density` = `PreSch Count`/Area * 1000000)
```

# 9 Explorotary Data Analysis (EDA)

## 9.1 Histogram to showdistribution of PreSch Density
```{r echo=TRUE, eval=TRUE, fig.width=5, fig.height=5}
hist(mpsz3414$`PreSch Density`)
```

## 9.2 Enhance histogram using **ggplot**
```{r echo=TRUE, eval=TRUE, fig.width=5, fig.height=5}
ggplot(data=mpsz3414, 
       aes(x= as.numeric(`PreSch Density`)))+
  geom_histogram(bins=20, 
                 color="black", 
                 fill="light blue") +
  labs(title = "Are pre-school even distributed in Singapore?",
       subtitle= "There are many planning sub-zones with a single pre-school, on the other hand, \nthere are two planning sub-zones with at least 20 pre-schools",
      x = "Pre-school density (per km sq)",
      y = "Frequency")
```

## 9.3 Plot a scatterplot showing the relationship between Pre-school Density and Pre-school Count.

### 9.3.1 Default, showing different scale for x and y axis
```{r echo= TRUE, fig.width=5, fig.height=5}
ggplot(data=mpsz3414, 
       aes(y = `PreSch Count`, 
           x= as.numeric(`PreSch Density`)))+
  geom_point(color="black", 
             fill="light blue") + 
  labs(title = "",
      x = "Pre-school density (per km sq)",
      y = "Pre-school count")

```

### 9.3.2 Edit **xlim and ylim** to show same scale for x and y axis
```{r echo=FALSE, fig.width=5, fig.height=5}
ggplot(data=mpsz3414, 
       aes(y = `PreSch Count`, 
           x= as.numeric(`PreSch Density`)))+
  geom_point(color="black", 
             fill="light blue") + 
  xlim(0, 60) +
  ylim(0, 60) +
  labs(title = "",
      x = "Pre-school density (per km sq)",
      y = "Pre-school count")
```

Done! :)

