---
title: "Take-home Exercise 1"
description: |
  This exercise provides an in-depth Geospatial Analysis of the cumulative COVID-19 confirmed cases and death rates in its sub-districts (keluruhan) using appropriate thematic and analytics mapping techniques and R functions. 
author:
  - name: Nor Aisyah
    url: https://www.linkedin.com/in/nor-aisyah/
date: 09-10-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 4
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# 1. Background Information

This analysis aims to analyse the spatio-temporal patterns of monthly cumulative confirmed COVID-19 rate and death cases rate at keluruhan (sub-district) level of Daerah Khusus Ibukota Jakarta (DKI Jakarta). In other words, this analysis is done to detect which sub-districts had a relatively higher number of confirmed cases and death cases rates and how they changed over time. Additionally, the temporal interval will be at the last day of the month while the geographic will be at the sub-district.

# 2. Dataset
The data set used for this analysis includes:

1. **Aspatial**: Daily updates of COVID-19 statistics in DKI Jakarta at https://riwayat-file-covid-19-dki-jakarta-jakartagis.hub.arcgis.com. The cumulative data is available in the **"data" worksheet**.

2. **Geospatial**: Shapefile (SHP) Batas Desa Provinsi DKI Jakarta provided at  
[PODES 2019](https://www.indonesia-geospasial.com/2020/04/download-shapefile-shp-batas-desa.html).
There are other geospatial data in ESRI shapefile format at different geographical levels available at [Indonesia Geospatial](https://www.indonesia-geospasial.com/). But for the purpose of this analysis, only *SHP Batas Desa Provinsi DKI Jakarta will be used*.

Before we proceed with the analysis, there were some issues found when downloading the aspatial dataset which we need to take note of:

- Although we are expected to download 19 files from **31 January 2020 - 31 July 2021** (19 months), the link only has data files starting from 25 March 2020 onwards.
- Additionally, the link for 31st January 2021 Riwayat File Covid-19 DKI Jakarta was inaccessible.

Hence, the remedy is to:

- Take data files starting from **31st March 2020** instead
- For January 2021, use the data file for 30th January 2021 instead.
- Altogether, instead of 19 files, there are a total of 17 files to be downloaded.

# 3. Install and Load R packages 

This code chunk performs 3 tasks:

- A list called packages will be created and will consists of all the R packages required to accomplish this hands-on exercise.
- Check if R packages on package have been installed in R and if not, they will be installed.
- After all the R packages have been installed, they will be loaded.  

```{r echo=TRUE, eval=TRUE}
packages <- c('sf', 'tidyverse', 'tmap', 'kableExtra', 'ggpubr', 'devtools', 'gifski')
for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

```{r echo=TRUE, eval=TRUE, results="hide"}
devtools::install_github("gadenbuie/xaringanExtra")
library(xaringanExtra)
```

```{r panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

More on the packages used:

- **sf**: used for importing, managing, and processing **geospatial** data
  - specifically **vector-based** geospatial data
- **tidyverse**: used for importing, wrangling and visualising data. It consists of a family of R packages, such as:
  - **readr** for importing csv data,
  - **readxl** for importing Excel worksheet,
  - **tidyr** for manipulating data,
  - **dplyr** for transforming data, and
  - **ggplot2** for visualising data
- **tmap**: provides functions for plotting cartographic **quality** *static* point patterns maps or *interactive* maps by using leaflet API.
- **kableExtra**: Designed to extend the basic functionality of tables. In this exercise, I will be using it to construct complex tables and customize styles using a readable syntax. 
- **devtools**: used for installing any R packages which is not available in RCRAN. In this exercise, I will be installing using devtools to install the package **xaringanExtra** which is still under development stage. 
- **xaringanExtra**: is an enhancement of xaringan package. As it is still under development stage, we can still install the current version using install_github function of devtools. This package will be used to add Panelsets to contain both the r code chunk and results whereever applicable.

# 4. Importing Geospatial Data
## 4.1 Importing polygon feature data in shapefile format
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r echo=TRUE, eval=TRUE}
dkij_sf <- st_read("data/geospatial", layer="BATAS_DESA_DESEMBER_2019_DUKCAPIL_DKI_JAKARTA")
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r echo=TRUE, eval=TRUE}
glimpse(dkij_sf)
```
:::
:::::


- From the results above we can see that:
  - There are **269  multipolygon features and 161 fields** in the sf data frame. 
  - **WGS 84** is the Geodetic Coordinate Reference Systems

## 4.2 Retrieve coordinate reference system from object using **st_crs** of sf package
```{r echo=TRUE, eval=TRUE}
st_crs(dkij_sf)
```

- From the results above we can see that:
  - The EPSG is 4326 due to the Geodetic Coordinate Reference Systems being WGS 84.
  - Hence, what we need to do next is to assign the correct EPSG code to this simple feature data frame.
  
## 4.3 Assign EPSG code to a simple feature data frame
### 4.3.1 Assign correct EPSG code
- The national Projected Coordinates Systems of Indonesia is **DGN95 / Indonesia TM-3 zone 54.1**. 
- Hence, when we search this information up in https://epsg.io/ to retrieve the EPSG code, we get **23845** as the EPSG code.
- So, we can assign this EPSG code to st_crs by using **st_set_crs** of sf package as seen in the code chunk below:

```{r echo=TRUE, eval=TRUE}
dkij_sf23845<- st_transform(dkij_sf, crs = 23845)
```

### 4.3.2 Check CSR again
```{r echo=TRUE, eval=TRUE}
st_crs(dkij_sf23845)
```

### 4.3.3 Plot dkij_sf23845
```{r echo=TRUE, eval=TRUE}
plot(dkij_sf23845)
```

- From the plots above, we can roughly see that there are outer islands in map. Hence, we would need to exclude them from our analysis. 

# 5. Geospatial Data Wrangling

## 5.1 Exclude outer islands from DKI Jakarta 
- With prior research to what exactly are the outer islands of DKI Jakarta, my initial findings was that these outer islands are called **Thousand Islands** which can be translated to **Kepulauan Seribu**. 
- However, since this research is not enough, to help us confirm on what exactly defines the outer islands of DKI Jakarta, we can make use of **tmap_mode** of tmap package to look into the islands outside of DKI jakarta and check the field name.
- The idea is that if there is a pattern found within these outer islands (ie. a common field that defines them), we will use that field value to exclude them from the geospatial data.
- We will also be using the polygon of the **KAB_KOTA** field to look into this as the English translation for KAB_KOTA is Cities.

### 5.1.1 Check islands using **tmap_mode**
```{r echo=TRUE, eval=TRUE}
tmap_mode('view')
tm_shape(dkij_sf23845)+
  tm_polygons("KAB_KOTA")
```

Here we are switching back to plot mode since each interactive mode will consume a connection: 

```{r echo=TRUE, eval=TRUE}
tmap_mode('plot')
```

From the interactive map above, we can see that:

- From the colors legend, there are 6 unique values (Excluding missing value) for the KAB_KOTA field. 
- 5 out of these 6 unique values begins with **"JAKARTA"**. To understand these fields better, the translations are:
  - JAKARTA BARAT: West Jakarta
  - JAKARTA PUSAT: Center Jakarta
  - JAKARTA SELATAN: South Jakarta
  - JAKARTA TIMUR: East Jakarta
  - JAKARTA UTARA: North Jakarta
- The color legend also helps us to see better the cardinal directions of these cities and whether there is any overlap. For example, JAKARTA PUSAT represented in Yellow is at the center while JAKARTA UTARA represented in Blue is at the north.  
- When researching on these cities further, they are actually called the **5 administrative cities** (kota administrasi) which form the Special Capital Region of Jakarta, Indonesia also known as DKI Jakarta in Indonesian language.
- Hence when zooming in to the only value that does not begin with "JAKARTA" which is **"KEPULAUAN SERIBU"**, we can see for ourselves that it is in fact this value that is referring to the outer islands of Jakarta.

### 5.1.2 Exclude outer islands ("KEPULAUAN SERIBU") from DKI Jakarta using **filter** function
```{r echo=TRUE, eval=TRUE}
dkij_5cities <- filter(dkij_sf23845, KAB_KOTA != "KEPULAUAN SERIBU")
```

### 5.1.3 Plot dkij_5cities
```{r echo=TRUE, eval=TRUE}
plot(dkij_5cities)
plot(dkij_5cities["KAB_KOTA"])
```

## 5.2 Retain first 9 fields using **basic indexing** of baseR.

::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r echo=TRUE, eval=TRUE}
dkij_slice<- dkij_5cities[1:9]
```
:::

::: {.panel}
## Head {.panel-name}
```{r echo=TRUE, eval=TRUE}
head(dkij_slice)
```
:::
:::::

From the results above, we can see that the remaining fields after slicing are as follows: 

- OBJECT_ID  
- KODE_DESA
- DESA
- KODE
- PROVINSI
- KAB_KOTA
- KECAMATAN    
- DESA_KELUR 
- JUMLAH_PEN  

# 6. Importing, Extracting and Wrangling Aspatial Data  

During the first try of reading the excel files, there were some data issues encountered:

- **Duplicated column names**: Some of the excel files either contained 2 *ID_KEL* columns or 2 *Meninggal columns*. 
- **Required columns containing NA**: Some of the excel files that contained 2 of the *Meninggal* columns, have different value where the first column consists of all NA values while the second column was without NA values. 
- **Required column containing other values**: For *ID_KEL* column, there are some string values (ie. "LUAR DKI JAKARTA", "PROSES UPDATE DATA", "BELUM DIKETAHUI") which we need to remove in order to successfully integrate with the geospatial data later. 

Hence, when reading the excel files, we should aim to resolve these data issues first before successfully integrating the monthly data into 1 dataframe.

## 5.1 Import and extract required columns

The following code chunk performs 6 tasks:

- Read the "data" sheet of all the COVID excel files in the aspatial folder    
  - Although there are 2 excel sheets in each excel, the data that we require is only in the sheet named **data**
- Remove duplicated columns except the last instance 
  - This is to cater to both the duplicated columns: **ID_KEL** and **Meninggal** 
  - The pattern noticed in the duplicated **Meninggal** columns is that the column with the non NA values are always in the last duplicated column. For example, if there are 2 **Meninggal** (Meninggal, Meninggal.1) where Meninggal comes before Meninggal.1, the non NA column is always in the second/last column Meninggal.1. 
  - The pattern noticed for ID_KEL is that both its duplicated columns are always the same. Hence, we can choose to retain either one of them.  
- Convert tibbles to dataframe
- Extract the 7 required columns from COVID aspatial data:

      1. ID_KEL, 
      2. Nama_provinsi, 
      3. nama_kota, 
      4. nama_kecamatan 
      5. nama_kelurahan, 
      6. POSITIF (cumulative confirmed cases),
      7. meninggal (cumulative death cases) from data worksheet of the daily COVID-19 data
      
- Extract and create Month and Year columns derived from file name
- Drop rows where values in ID_KEL column are not digits
  - Some examples of string values found in the ID_KEL column include: "LUAR DKI JAKARTA", "PROSES UPDATE DATA", "BELUM DIKETAHUI"

```{r echo=TRUE, eval=FALSE}
aps_path = "data/aspatial"

filenames <- list.files(path = aps_path, pattern = "*.xlsx", full.names = T)

aspatial <- lapply(filenames, function(i){
    data <- which(readxl::excel_sheets(i) == "data") 
    xl <- readxl::read_xlsx(i, sheet=data, .name_repair = "minimal")
    non_dup <- xl[, !duplicated(colnames(xl), fromLast = TRUE)]
    df <-data.frame(non_dup)
    req_col_df <-  select(df, `ID_KEL`, `Nama_provinsi`, `nama_kota`, `nama_kecamatan`, `nama_kelurahan`, `POSITIF`, `Meninggal`)
    full_date <- gsub(".*\\([0-9]{2} (.*)\\).*", "\\1", i)
    month <- gsub('(^\\w+)\\s.+','\\1',full_date)
    year <- gsub('^.*([0-9]{4}).*','\\1', full_date)
    req_col_df$Month = toupper(month)
    req_col_df$Year = strtoi(year)
    req_col_df$MthYr <- paste(req_col_df$Month, req_col_df$Year, sep="_")
    req_col_df <- req_col_df %>% filter(grepl("[[:digit:]]", ID_KEL))

    return(req_col_df)

})
```

## 6.2 Integrate the daily data into a data frame by month using *rbind.data.frame* 
```{r echo=TRUE, eval=FALSE}
covid_df <- do.call("rbind.data.frame", aspatial)
```

## 6.3 Save Aspatial file as RDS

Before proceeding with our analysis, it is important to save our aspatial data as an RDS file so that we can **avoid**:

- Reading multiple excel files and performing the same set of data transformation process everytime we run the rmd file
- Uploading multiple excel files onto Github 
  - Github has a maximum size limit of 100mb for individual files. 
  - Although the current files do not exceed this limit, it is good practice to still save it as RDS file so that there won't be any complications when we eventually work with relatively large files. 
  
```{r echo=TRUE, eval=FALSE}
covid_df_rds <- write_rds(covid_df, "data/aspatial/rds/covid_df.rds")
```

## 6.4 Read RDS Aspatial file
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r echo=TRUE, eval=TRUE}
covid_df <- read_rds("data/aspatial/rds/covid_df.rds")
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r echo=TRUE, eval=TRUE}
glimpse(covid_df)
```
:::
:::::

We can see that there are a total of **4,539 rows** in the COVID aspatial data.

# 7. Integrate Aspatial and Geospatial data 

## 7.1 Combine COVID aspatial data and DKI Jakarta geospatial frame into simple feature data frame using **left_join**

**dkij_slice** will be used as the main table since the outer islands have already been excluded from it. 

### 7.1.1 Choosing the join key

Although there are multiple fields that can be mapped like
  - KECAMATAN->nama_kecamatan, 
  - DESA_KELUR->nama_kelurahan, 

We will only be using **KODE_DESA** from dkij_slice and **ID_KEL** from covid_df to join since there are some discrepancies found with the other fields. Below are some examples of the discrepancies found: 

- In KECAMATAN, there is a value "SETIABUDI" but in nama_kecamatan, the value is "SETIA BUDI".
- In DESA_KELUR, there is a value "HALIM PERDANA KUSUMA" but in nama_kelurahan, the value is "HALIM PERDANA KUSUMAH" .

The following code chunk helps us to see how we can observe these discrepancies in the columns: 

#### 7.1.1.1 Discrepancies between **KECAMATAN** and **nama_kecamatan**
```{r echo=TRUE, eval=TRUE}
KECAMATAN <- unique(dkij_slice$KECAMATAN)
nama_kecamatan <- unique(covid_df$nama_kecamatan)
```

- Values in KECAMATAN not found in nama_kecamatan: 

```{r echo=TRUE, eval=TRUE}
KECAMATAN[!(KECAMATAN %in% nama_kecamatan)]
```

- Values in nama_kecamatan not found in KECAMATAN: 

```{r echo=TRUE, eval=TRUE}
nama_kecamatan[!(nama_kecamatan %in% KECAMATAN)]
```

#### 7.1.1.2 Discrepancies between **DESA_KELUR** and **nama_kelurahan**
```{r echo=TRUE, eval=TRUE}
DESA_KELUR <- unique(dkij_slice$DESA_KELUR)
nama_kelurahan <- unique(covid_df$nama_kelurahan)
```

- Values in DESA_KELUR not found in nama_kelurahan: 

```{r echo=TRUE, eval=TRUE}
DESA_KELUR[!(DESA_KELUR %in% nama_kelurahan)]
```

- Values in nama_kelurahan not found in DESA_KELUR: 

```{r echo=TRUE, eval=TRUE}
nama_kelurahan[!(nama_kelurahan %in% DESA_KELUR)]
```

### 7.1.2 Join geospatial and aspatial data using selected join key

::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r echo=TRUE, eval=TRUE}
dki_cov <- left_join(dkij_slice, covid_df, by = c('KODE_DESA' ='ID_KEL'))
```
:::
::: {.panel}
## Head {.panel-name}
```{r echo=TRUE, eval=TRUE}
kable(head(dki_cov)) %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "400px")
```
:::
:::::

## 7.2 Calculate cumulative confirmed cases rate (i.e. cases per 10000 population) and the cumulative death cases rate by month

The formula that will be used in this calculation is as such:

- Cumulative confirmed cases rate  = (Total Confirmed cases per month and sub-district/Population of sub-district)*10000
- Cumulative death cases rate = (Total Death cases per month and sub-district/Population of sub-district)*10000

### 7.2.1 Check for any NA values in the df
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
colSums(is.na(dki_cov))
```

### 7.2.2 Set geometry to NULL first as we need to pivot our table for the calculation later 
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
dki_cov_wogeo <- st_set_geometry(dki_cov, NULL) 
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(dki_cov_wogeo)
```
:::
:::::

### 7.2.3 Perform calculation for cumulative confirmed cases rate by month (POSITIF)
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cumu_cc_rate <- dki_cov_wogeo %>%
  group_by(KODE_DESA, nama_kelurahan, MthYr, JUMLAH_PEN)  %>%
  summarise(`TOTAL_CONFIRMED` = sum(`POSITIF`))  %>%
  ungroup()  %>%
  mutate(`cumu_cc_rate` = `TOTAL_CONFIRMED`/`JUMLAH_PEN`*10000)  %>%
  select(`KODE_DESA`, `nama_kelurahan`, `JUMLAH_PEN`, `MthYr`, `cumu_cc_rate`) %>%
  pivot_wider(names_from=MthYr, 
              values_from=cumu_cc_rate)
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(cumu_cc_rate)
```
:::
:::::


### 7.2.4 Perform calculation for cumulative death cases rate by month (Meninggal)
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cumu_death_rate <- dki_cov_wogeo %>%
  group_by(KODE_DESA, nama_kelurahan, MthYr, JUMLAH_PEN)  %>%
  summarise(`TOTAL_DEATHS` = sum(`Meninggal`))  %>%
  ungroup()  %>%
  mutate(`cumu_death_rate` = `TOTAL_DEATHS`/`JUMLAH_PEN`*10000)  %>%
  select(`KODE_DESA`, `nama_kelurahan`, `JUMLAH_PEN`, `MthYr`, `cumu_death_rate`) %>%
  pivot_wider(names_from=MthYr, 
              values_from=cumu_death_rate)
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(cumu_death_rate)
```
:::
:::::

### 7.2.5 Perform calculation for relative risk

Relative risk also known as standardized mortality rate (SMR) is sometimes used to compare the observed mortality rate to a national (or regional) standard. This means that we would want to compare the death rates of the individual sub districts to the national DKI death rates. 

::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
rel_risk <- dki_cov_wogeo %>%
  mutate(`TOTAL_DEATHS` = sum(`Meninggal`)) %>%
  mutate(`REL_RISK` = (`TOTAL_DEATHS`*100)/ `TOTAL_DEATHS`/`JUMLAH_PEN`) %>%
  select (`KODE_DESA`, `REL_RISK`)

```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(rel_risk)
```
:::
:::::

::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
total_deaths <- dki_cov_wogeo %>%
  group_by(KODE_DESA, nama_kelurahan, JUMLAH_PEN)  %>%
  summarise(`TOTAL_DEATHS` = sum(`Meninggal`))  %>%
  ungroup()  %>%
  select (`KODE_DESA`, `TOTAL_DEATHS`, `JUMLAH_PEN`, nama_kelurahan)

```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(total_deaths)
```
:::
:::::





 8. Exploratory Data Analysis 

## 8.1 Create a vector containing the months column names in ascending order
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
months_col <- c('MARET_2020','APRIL_2020','MEI_2020','JUNI_2020','JULI_2020','AGUSTUS_2020','SEPTEMBER_2020','OKTOBER_2020','NOVEMBER_2020','DESEMBER_2020','JANUARI_2021','FEBRUARI_2021','MARET_2021','APRIL_2021','MEI_2021','JUNI_2021','JULI_2021')
```

## 8.2 Cumulative confirmed cases rates 
### 8.2.1 Time Series Box Plot - Cumulative confirmed cases rates
#### 8.2.1.1 Create a list containing all the boxplots by months

The following code chunk will perform 2 tasks:

- Create a list called cc_boxplot_list to store the boxplots
- For each month_year, create a boxplot using the ggplot2 package and store it in the cc_boxplot_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cc_boxplot_list <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  box_plot <- ggplot(cumu_cc_rate, aes_string(x = months_col[[i]])) +
    geom_boxplot(color="midnight blue", fill="light sky blue") +
    labs(title = months_col[[i]]) +
    theme(plot.title = element_text(size = 10),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank())
  cc_boxplot_list[[i]] <- box_plot
}
```

#### 8.2.1.2 Plot boxplots to examine DKI Jakarta's COVID-19 cases rates across months 
- Here we are using **ggarrange** function which is a useful function to arrange multiple ggplots on the same page

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
ggarrange(plotlist = cc_boxplot_list,
          ncol = 5,
          nrow = 4)
```
Here are some of the observations that we can draw from the boxplots of the cumulative confirmed cases rates above:

- The distribution of DKI Jakarta's COVID-19 cumulative confirmed cases rates across the months are **right-skewed**.
- In all of the months from March 2020 to July 2021, there are multiple sub-districts (kelurahan) which have extremely high cumulative confirmed cases rates as compared to the other sub-districts. This is indicated by the multiple far upper outliers.
- As the range of the cumulative confirmed cases rate in DKI Jakarta increases over the months (indicated by the increase in the axis), the threshold defining an outlier also increases. 
- From November 2020 onwards, two sub-districts are always noticeable at the far end of the upper outlier. 
- Starting from October 2020 onwards, none of the sub-districts had  a cumulative confirmed case rate of 0.


### 8.2.2 Time Series Histogram - Cumulative confirmed cases rates
#### 8.2.2.1 Create a list containing all the histogram by months

The following code chunk will perform 2 tasks:

- Create a list called cc_histogram_list to store the histograms
- For each month_year, create a histogram using the ggplot2 package and store it in the cc_histogram_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cc_histogram_list <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  hist_plot <- ggplot(cumu_cc_rate, aes_string(x = months_col[[i]])) +
    geom_histogram(fill = "steel blue") +
    labs(title = months_col[[i]]) +
    theme(plot.title = element_text(size = 10),
          axis.title = element_blank())
  
  cc_histogram_list[[i]] <- hist_plot
}
```

#### 8.2.2.2 Plot histograms to examine DKI Jakarta's COVID-19 cumulative confirmed cases rates across months
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
ggarrange(plotlist = cc_histogram_list,
          ncol = 5,
          nrow = 4)
```

Here are some of the observations that we can draw from the cumulative confirmed cases histogram above:

- The distribution of COVID-19 cumulative confirmed cases rates across the months are **right-skewed**.
- In March 2020, the **majority** of the sub-districts (keluruhan) had a cumulative confirmed cases rate of **0**. This might be because the very first case finding in Indonesia was announced on **2nd March 2020** according to: [Situation report #5: COVID-19 pandemic - 24th March 2020 - Indonesia](https://reliefweb.int/report/indonesia/situation-report-5-covid-19-pandemic-24th-march-2020). 
- Hence, as months passed and as cases spread across all the provinces in Indonesia, the number of sub-districts in DKI Jakarta having a cumulative confirmed case rate of 0 dropped. 
- Starting from October 2020, none of the sub-districts had a cumulative confirmed case rate of 0. 


## 8.3 Cumulative death cases rates
### 8.3.1 Time Series Box Plot - Cumulative death cases rates
#### 8.3.1.1 Create a list containing all the boxplots by months
The following code chunk will perform 2 tasks:

- Create a list called death_boxplot_list to store the boxplots
- For each month_year, create a boxplot using the ggplot2 package and store it in the death_boxplot_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
# Create a list to store the boxplots
death_boxplot_list <- vector(mode = "list", length = length(months_col))
# For each month_year, create a boxplot using the ggplot2 package and store it in the boxplot_list created
for (i in 1:length(months_col)) {
  box_plot <- ggplot(cumu_death_rate, aes_string(x = months_col[[i]])) +
    geom_boxplot(color="firebrick", fill="light coral") +
    labs(title = months_col[[i]]) +
    theme(plot.title = element_text(size = 10),
          axis.title = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank())
  death_boxplot_list[[i]] <- box_plot
}
```

#### 8.3.1.2 Plot boxplots to examine DKI Jakarta's COVID-19 death cases rates across months 
- Here we are using **ggarrange** function which is a useful function to arrange multiple ggplots on the same page

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
ggarrange(plotlist = death_boxplot_list,
          ncol = 5,
          nrow = 4)
```

Here are some of the observations that we can draw from the boxplots of the cumulative death cases rates above:

- In comparison to the cumulative confirmed cases rates boxplots, the distribution of DKI Jakarta's COVID-19 cumulative death cases rates across the months are **also right-skewed**.
- Similarly, in all of the months from March 2020 to July 2021, there are multiple sub-districts which have high cumulative death cases rates as compared to the other sub-districts.
- As the range of the cumulative death cases rates in DKI Jakarta increases over the months, the threshold defining an outlier also increases. 
- Starting from February 2021, one sub-district can be seen always appearing at the far end of the upper outlier. Additionally, starting from February 2021, the minimum of the boxplot (minimum cumulative death cases rates) is no longer 0. 

### 8.3.2 Time Series Histogram - Cumulative death cases rates
#### 8.3.2.1 Create a list containing all the histogram by months
The following code chunk will perform 2 tasks:

- Create a list called death_histogram_list to store the histograms
- For each month_year, create a histogram using the ggplot2 package and store it in the death_histogram_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
death_histogram_list <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  hist_plot <- ggplot(cumu_death_rate, aes_string(x = months_col[[i]])) +
    geom_histogram(fill = "firebrick") +
    labs(title = months_col[[i]]) +
    theme(plot.title = element_text(size = 10),
          axis.title = element_blank())
  
  death_histogram_list[[i]] <- hist_plot
}
```

#### 8.3.2.2 Plot histograms to examine DKI Jakarta's COVID-19 cumulative death cases rates across months
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
ggarrange(plotlist = death_histogram_list,
          ncol = 5,
          nrow = 4)
```


Here are some of the observations that we can draw from the histograms of the cumulative death cases rates above:

- The distribution of COVID-19 cumulative death cases rates across the months are **right-skewed**.
- In March 2020, the **majority** of the sub-districts (keluruhan) had a cumulative death cases rates of **0**. 
- As months passed, the number of sub-districts in DKI Jakarta having a cumulative death cases rate of 0 dropped. 
- Starting from February 2021 onwards, none of the sub-districts had a cumulative death cases rate of 0.


# 9. Thematic Mapping

As seen from the previous sections, both the cumulative confirmed cases and death cases rates by month vary significantly. Hence, when we perform thematic mapping, we should carefully choose how we decide to define the intervals that are able to show significant spatio-temporal patterns. 

Additionally, although it is known that the distribution for both the cumulative confirmed cases and death cases rates are right skewed, I will still be showing the difference between the maps with Manually Defined classification and Jenks classification. Equal and Quantiles classification will not be plotted for this analysis as: 

- Equal classification is more appropriate for variables with a **uniform** distribution
- Quantiles classification is more well suited for **linearly** distributed data.

## 9.1 Time-series choropleth map of COVID-19 rates - **Manual Classification**
### 9.1.1 Check summary of cumulative confirmed cases rate by month (POSITIF)
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
summary(cumu_cc_rate)
```

- From March 2020 to July 2021, it can be seen that the cumulative confirmed cases rate ranges from 0 to about 3810. 
- If we were to manually define the intervals, we would get 9 classes of intervals of 450. 


### 9.1.2 Check summary of cumulative death cases rate by month (Meninggal)
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
summary(cumu_death_rate)
```

- From March 2020 to July 2021, it can be seen that the cumulative death cases rate ranges from 0 to about 42. 
- If we were to manually define the intervals, we would get 9 classes intervals of 5. 

## 9.1.3 Join cumulative confirmed rates with dkij_slice sf dataframe 

### 9.1.3.1 Cumulative confirmed cases rates 
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cumu_cc_dkij <- left_join(dkij_slice, cumu_cc_rate, by = c('KODE_DESA' ='KODE_DESA', 'JUMLAH_PEN' = 'JUMLAH_PEN'))
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(cumu_cc_dkij)
```
:::
:::::

### 9.1.3.2 Cumulative death cases rates 
::::: {.panelset}
::: {.panel}
## Code Chunk {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cumu_death_dkij <- left_join(dkij_slice, cumu_death_rate, by = c('KODE_DESA' ='KODE_DESA', 'JUMLAH_PEN' = 'JUMLAH_PEN' ))
```
:::
::: {.panel}
## Glimpse {.panel-name}
```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
glimpse(cumu_death_dkij)
```
:::
:::::


### 9.1.4 Time-series choropleth map of cumulative confirmed cases rates (Manual Classification)
#### 9.1.4.1 Create list containing all maps by months
The following code chunk will perform 2 tasks:

- Create a list called cc_map_list to store the maps
- For each month_year, create a map using the tmap package and store it in the cc_map_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cc_map_list_manual <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- tm_shape(cumu_cc_dkij) +
            tm_fill(col = months_col[[i]],
                    palette = 'Blues',
                    breaks = c(0, 450, 900, 1350, 1800, 2250, 2700, 3150, 3600, 4050)
                    
                    ) +
            tm_borders(lwd = 0.1,
                       alpha = 0.3) +
            tm_layout(panel.show = TRUE,
                      panel.labels = months_col[[i]],
                      panel.label.color = 'black',
                      panel.label.size = 0.5,
                      legend.show = TRUE,
                      legend.text.size = 0.5,
                      inner.margins = 0
                      )
  cc_map_list_manual[[i]] <- cmap
}
```

#### 9.1.4.2 Arrange maps to create a time-series visualisation of choropleth maps across months
```{r echo=TRUE, layout="l-page", fig.width=5, fig_height=5}
tmap_arrange(cc_map_list_manual, outer.margins=0, ncol = 3)
```


### 9.1.5 Time-series choropleth map of cumulative death cases rates (Manual Classification)
#### 9.1.4.1 Create list containing all maps by months
The following code chunk will perform 2 tasks:

- Create a list called death_map_list to store the maps
- For each month_year, create a map using the tmap package and store it in the death_map_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
death_map_list_manual <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- tm_shape(cumu_death_dkij) +
            tm_fill(col = months_col[[i]],
                    palette = 'Reds',
                    breaks = c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45)) +
            tm_borders(lwd = 0.1,
                       alpha = 0.3) +
            tm_layout(panel.show = TRUE,
                      panel.labels = months_col[[i]],
                      panel.label.color = 'black',
                      panel.label.size = 0.5,
                      legend.show = TRUE, 
                      legend.text.size = 0.5,
                      inner.margins = 0
                      )
  death_map_list_manual[[i]] <- cmap
}
```

#### 9.1.5.2 Arrange maps to create a time-series visualisation of choropleth maps across months
```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(death_map_list_manual, ncol = 3, outer.margins=0)
```

From both the cumulative confirmed and death cases maps above, some observations that can be found are:

- Sub-districts in the Central Region of Jakarta had higher COVID-19 cumulative confirmed cases rate which is indicated by the darker shade of blue which can be visible from Feb 2021 onwards.
- Sub-districts with higher COVID-19 cumulative cases rates also had higher cumulative death cases rates which is indicated by the darker shade of red. Again, this can be seen in the Central Region from Jan 2021 onwards.
- The spatial patterns in the earlier months however can hardly be observed as this is due to the manual classification used.

Some disadvantages that are commonly known when using this manual classification are:

- Intervals of 450 will have the tendency to over-generalize the data since the cumulative confirmed cases rates in the earlier months (March 2020 to November 2020) are relatively low as compared to the later months. This will also result in loss of important spatial patterns which we would want to avoid. 
- Similarly, for cumulative death cases rates, intervals of 5 may not be ideal as we are unable to capture important patterns of those cumulative death cases rates that are relatively low in the earlier months. 
- Both the cumulative confirmed cases and death cases rates are right skewed. Hence, those outliers that are observed in the previous boxplots are more likely to produce empty classes. 

Therefore, since our distribution for both cumulative confirmed cases and death cases rates are right skewed, it would be better to use Natural Breaks classification to plot the choropleth maps for both cumulative confirmed cases and death rates instead.


## 9.2 Time-series choropleth map of COVID-19 rates (Jenks Classification)

### 9.2.1 Time-series choropleth map of cumulative confirmed cases rates (Jenks Classification)
#### 9.2.1.1 Create list containing all maps by months
The following code chunk will perform 2 tasks:

- Create a list called cc_map_list to store the maps
- For each month_year, create a map using the tmap package and store it in the cc_map_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
cc_map_list_jenks <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- tm_shape(cumu_cc_dkij) +
            tm_fill(col = months_col[[i]],
                    palette = 'Blues',
                    style = 'jenks',
                    n = 5) +
            tm_borders(lwd = 0.1,
                       alpha = 0.3) +
            tm_layout(panel.show = TRUE,
                      panel.labels = months_col[[i]],
                      panel.label.color = 'black',
                      panel.label.size = 0.5,
                      legend.show = TRUE,
                      legend.text.size = 0.5,
                      inner.margins = 0)
  cc_map_list_jenks[[i]] <- cmap
}
```

#### 9.2.1.2 Arrange maps to create a time-series visualisation of choropleth maps across months
```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(cc_map_list_jenks, ncol = 3, outer.margins=0)
```

- With the Jenks classification, Spatial-temporal patterns can now be observed for all months. 
- In March 2020 when COVID-19 outbreak first started in Indonesia, the most obvious cluster that can be seen in the sub-districts located at the South West region of Jakarta. 
- This began to change over the months as more clusters are formed near the central and north region of DKI Jakarta. This change can be seen in August 2020, with a higher concentration of confirmed cases in the central region, indicated by a darker shade of blue.
- Additionally, from August 2020 to July 2021, there is a particular sub-district in the central region of DKI Jakarta that has the darkest shade of blue. Referring to our boxplot created previously, we can now confirm that the uppermost outlier for the boxplots from August 2020 to July 20201 is in fact this particular sub-district. 


### 9.2.2 Time-series choropleth map of cumulative death cases rates (Jenks Classification)
#### 9.2.2.1 Create list containing all maps by months
The following code chunk will perform 2 tasks:

- Create a list called death_map_list to store the maps
- For each month_year, create a map using the tmap package and store it in the death_map_list created

```{r  echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
death_map_list_jenks <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- tm_shape(cumu_death_dkij) +
            tm_fill(col = months_col[[i]],
                    palette = 'Reds',
                    style = 'jenks',
                    n = 5) +
            tm_borders(lwd = 0.1,
                       alpha = 0.3) +
            tm_layout(panel.show = TRUE,
                      panel.labels = months_col[[i]],
                      panel.label.color = 'black',
                      panel.label.size = 0.5,
                      legend.show = TRUE,
                      legend.text.size = 0.5,
                      inner.margins = 0)
  death_map_list_jenks[[i]] <- cmap
}
```

#### 9.2.2.2 Arrange maps to create a time-series visualisation of choropleth maps across months
```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(death_map_list_jenks, ncol = 3, outer.margins=0)
```


- Similarly, for the choropleth maps of cumulative death cases rates created with the Jenks classification, spatial-temporal patterns can now be observed for all months. 
- In March 2020, the clusters for the cumulative death rates are at random sub-districts. However, as months passed, the most obvious cluster that had a more concentrated cumulative death rates are at the sub-districts of the central region of DKI Jakarta. This can be seen from August 2020 to November 2020 where the centre sub-districts are in a darker shade of red.  
- One interesting find here would be that, for the particular sub-district that had the highest cumulative confirmed cases rate previously from August 2020 to July 2021, it instead had the highest cumulative death cases rate only from January 2021 onwards. 


Overall, although choropleth maps provides a quick and easy way to spot spatial patterns, the observations are not conclusive as our data contains outliers. The next section will attempt to determine if these are more significant patterns that can be derived using extreme value maps. 




# 10. Analytical Mapping

As it is evident from the boxplots created earlier, the COVID data contains outliers. Hence, we can also make use of extreme value maps like percentile and box map to highlight these values at the lower and upper end of the scale. 

## 10.1 Box Map
### 10.1.1 Functions needed to plot box maps
- Get var function: For extracting the variable as vector out of the dataframe
- Box breaks function: Creating break points for the box map into 6 classes to classify the data points
  - "lower outlier"
  - "1 - 25%"
  - "25% - 50%"
  - "50% - 75%"
  - "> 75%"
  - "upper outlier"

```{r echo=TRUE, eval=TRUE}
# Extract variable as vector out of sf dataframe
get.var <- function(vname, df) {
  v <- df[vname]
  v <- unname(v[[1]])
  return(v)
}
# To create break points for box map
boxbreaks <- function(v, mult=1.5) {
  qv <- unname(quantile(v))
  iqr <- qv[4] - qv[2]
  upfence <- qv[4] + mult * iqr
  lofence <- qv[2] - mult * iqr
  # initialize break points vector
  bb <- vector(mode="numeric",length=7)
  # logic for lower and upper fences
  if (lofence < qv[1]) { # no lower outliers
    bb[1] <- lofence
    bb[2] <- floor(qv[1])
  } else {
    bb[2] <- lofence
    bb[1] <- qv[1]
  }
  if (upfence > qv[5]) { # no upper outliers
    bb[7] <- upfence
    bb[6] <- ceiling(qv[5])
  } else {
    bb[6] <- upfence
    bb[7] <- qv[5]
  }
  bb[3:5] <- qv[2:4]
  return(bb)
}
```

### 10.1.2 Box map function to plot the box map
```{r echo=TRUE, eval=TRUE}
# Boxmap function
boxmap <- function(vnam, df, 
                   legtitle=NA,
                   mult=1.5){
  var <- get.var(vnam,df)
  bb <- boxbreaks(var)
  tm_shape(df) +
     tm_fill(vnam,title=legtitle,
             breaks=bb,
             palette="Blues",
          labels = c("lower outlier", 
                     "< 25%", 
                     "25% - 50%", 
                     "50% - 75%",
                     "> 75%", 
                     "upper outlier"))  +
  tm_borders(lwd=0.1, alpha=0.3) +
  tm_layout(legend.show = TRUE)
}
```

### 10.1.3 Test boxbreaks function 
```{r echo=TRUE,  eval=TRUE}
var <- get.var("JULI_2021", cumu_cc_dkij)
boxbreaks(var)
```

### 10.1.4 Time-series box map of cumulative confirmed cases rates
```{r echo=TRUE, eval=TRUE}
cc_map_list_boxmap <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- boxmap(months_col[[i]], cumu_cc_dkij)
  cc_map_list_boxmap[[i]] <- cmap
}
```

```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(cc_map_list_boxmap, ncol = 3, outer.margins=0)
```


- From the above box maps, more sub districts are in a darker blue shade. From this, we can infer that more sub districts are in the upper outlier class which is also confirming the observation that we have seen in the earlier boxplots. 
- Although previously it is thought that the concentration of confirmed cases are in the centre region, we can see that over the months, the southern region of Jakarta seems to be appearing more in the upper outlier class. This can be seen from January 2021 onwards. This observation cannot be seen in the choropleth maps plotted previously using jenks classification.

### 10.1.5 Time-series box map of cumulative death cases rates
```{r echo=TRUE, eval=TRUE}
# Extract variable as vector out of sf dataframe
get.var <- function(vname, df) {
  v <- df[vname]
  v <- unname(v[[1]])
  return(v)
}

boxmap <- function(vnam, df, 
                   legtitle=NA,
                   mult=1.5){
  var <- get.var(vnam,df)
  bb <- boxbreaks(var)
  tm_shape(df) +
     tm_fill(vnam,title=legtitle,
             breaks=bb,
             palette="Reds",
          labels = c("lower outlier", 
                     "< 25%", 
                     "25% - 50%", 
                     "50% - 75%",
                     "> 75%", 
                     "upper outlier"))  +
  tm_borders(lwd=0.1, alpha=0.3) +
  tm_layout(title = NA,
            legend.show = TRUE)
}
```

```{r echo=TRUE, eval=TRUE}
death_map_list_boxmap <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- boxmap(months_col[[i]], cumu_death_dkij)
  death_map_list_boxmap[[i]] <- cmap
}
```

```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(death_map_list_boxmap, ncol = 3, outer.margins=0)
```



- Similarly, for the cumulative death cases rate, more sub districts are in a darker red shade as seen from the above box maps. From this, we can infer that more sub districts are in the upper outlier class which is also confirming the observation that we have seen in the earlier boxplots. 
- We can now see that the concentration of confirmed cases are not only in the centre region, but also spread out across the other regions. 
- There is also no clear indication as to which sub-district has the highest cumulative death cases rate over time as the rates seems to spread out more to all of the sub-districts in all DKI Jakarta's region. 
- However, we can see that towards the north of DKI Jakarta, the sub-districts had a relatively low cumulative death cases rate compared to the other areas.
- The only observation that is inaccurate would be the box map plotted for the month of March 2020 as almost all the sub-districts is classified in the upper outlier class. This might be due to the fact that most of the sub-districts having a lower death rate in March 2020 since COVID-19 outbreak only started in that month. This observation can also be seen from our boxplot and histogram created previously. 
- Another alternative to identify these outliers is to use is Percentile Maps which is shown in the next section. 


## 10.2 Percentile Maps
### 10.2.1 get.var function for Percentile Maps
```{r echo=TRUE, eval=TRUE}
get.var <- function(vname,df) {
  v <- df[vname] %>% 
    st_set_geometry(NULL)
  v <- unname(v[[1]])
  return(v)
}
```

### 10.2.2 Time-series percentile map of cumulative confirmed cases rates
#### 10.2.2.1 Time-series percentile map function
```{r echo=TRUE, eval=TRUE}
# Creating the percentmap function
percentmap <- function(vnam, df, legtitle=NA){
  percent <- c(0,.01, .1,.5,.9,.99,1)
  var <- get.var(vnam,df)
  bperc <- quantile (var, percent)
  tm_shape (cumu_cc_dkij) + 
    tm_polygons() + 
    tm_shape(df)+
    tm_fill(vnam, title=legtitle, breaks=bperc, palette="Blues", 
            labels = c("< 1%", "1%-10%", "10%-50%", "50%-90%", "90%-99%", ">99%"))+
     tm_borders(lwd=0.1, alpha = 0.3) +
    tm_layout(legend.show = TRUE)
    
}
```

#### 10.2.2.2 Create a list containing all maps by months
```{r echo=TRUE, eval=TRUE}
cc_map_list_percentile <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- percentmap(months_col[[i]], cumu_cc_dkij)
  cc_map_list_percentile[[i]] <- cmap
}
```

#### 10.2.2.3 Create visualistion of percentile maps across months 
```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(cc_map_list_percentile, ncol = 3, outer.margins=0)
```

- From the percentile maps shown above, we can see that more sub-districts are classified as 50% quantile and above classes.
- In comparison to the box maps above, the observations are quite similar. 
- However, it becomes more evident that the sub-districts in the centre region are the outliers here.


### 10.2.3 Time-series percentile map of cumulative confirmed death rates
#### 10.2.3.1 Time-series percentile map function
```{r echo=TRUE, eval=TRUE}
# Creating the percentmap function
percentmap <- function(vnam, df, legtitle=NA){
  percent <- c(0,.01, .1,.5,.9,.99,1)
  var <- get.var(vnam,df)
  bperc <- quantile (var, percent)
  tm_shape (cumu_death_dkij) + 
    tm_polygons() + 
    tm_shape(df)+
    tm_fill(vnam, title=legtitle, breaks=bperc, palette="Reds", 
            labels = c("< 1%", "1%-10%", "10%-50%", "50%-90%", "90%-99%", ">99%"))+
     tm_borders(lwd=0.1, alpha = 0.3) +
    tm_layout(legend.show = TRUE)
    
}
```

#### 10.2.3.2 Create a list containing all maps by months
```{r echo=TRUE, eval=TRUE}
death_map_list_percentile <- vector(mode = "list", length = length(months_col))
for (i in 1:length(months_col)) {
  cmap <- percentmap(months_col[[i]], cumu_death_dkij)
  death_map_list_percentile[[i]] <- cmap
}
```

#### 10.2.2.3 Create visualistion of percentile maps accross months 
```{r echo=TRUE, layout="l-page", fig.width=6, fig_height=5}
tmap_arrange(death_map_list_percentile, ncol = 3, outer.margins=0)
```


- From the percentile maps shown above, we can see that more sub-districts are classified as 50% quantile and above classes.
- In comparison to the box maps above, we can now clearly see the specific regions that are in the darker red shade and this would mean that they are the outliers that we saw in the box plots previously. 
- Over the months, we can also see clearly which are the outliers that below to the upper class indicated by the darkest red shade (>99% quantile).


## 10.3 Relative Risk map vs Total Deaths map 
```{r echo=TRUE, eval=TRUE}
rel_risk_geo <- left_join(dkij_slice, rel_risk, by = c('KODE_DESA' ='KODE_DESA'))
total_deaths_geo <- left_join(dkij_slice, total_deaths, by = c('KODE_DESA' ='KODE_DESA', 'JUMLAH_PEN'='JUMLAH_PEN'))

relative_risk_map <- tm_shape(rel_risk_geo) +
  tm_fill(col = "REL_RISK", n = 5, style = "jenks", title = "Relative Risk", palette="Greens") +
   tm_layout(main.title = "Relative Risk",
             main.title.position = "center",
             main.title.size = 1.5) + 
  tm_borders(alpha = 0.3) 

total_death_map <- tm_shape(total_deaths_geo)+
  tm_fill(col="TOTAL_DEATHS", style="jenks", n = 5, title= "Total Deaths", palette="Reds") +
   tm_layout(main.title = "Total Deaths",
             main.title.position = "center",
             main.title.size = 1.5) +
  tm_borders(alpha = 0.3) 

total_pop_map <- tm_shape(total_deaths_geo)+
  tm_fill(col="JUMLAH_PEN", style="jenks", n = 5, title= "Total Population", palette="Purples") +
   tm_layout(main.title = "Total Population",
             main.title.position = "center",
             main.title.size = 1.5) +
  tm_borders(alpha = 0.3) 



tmap_arrange(relative_risk_map, total_death_map, total_pop_map, ncol=3)
```

- From the maps above, we can see that it is not always the case that those sub districts with a higher total deaths having a higher relative risk.
- Areas with high population count and deaths has generally lower relative risk and vice versa. 

# 11. Conclusion
Some of the conclusions that we can derive from this analysis includes:

- Using manual classification is not recommended whenever there is a right skewed distribution in our data, unless we know specifically which intervals are the best to use, as it shows little to no important patterns.
- Using a proper data classification when plotting chloropleth maps is crucial as more significant patterns can be observed (more darker shades or blue and red) for both cumulative confirmed and death cases rate.
- It is generally useful to further enhance our analysis when our data consists of outliers using percentile maps and box maps.However, different maps have the ability to show different kinds of patterns. We should ultimately choose specific ones to fit our data.
- The patterns from the spatial temporal analysis of cumulative confirmed cases rate were more significant when using a box map while the patterns from the spatial temporal analysis of cumulative death cases rate were more significant when using a percentile map. 
- In the Relative Risk map, it shows that sub-districts with higher total deaths does not necessarily lead to a higher relative risk.
- Similarly, in the chloropleth maps using Jenks classification, it also shows that sub-districts with a higher cumulative confirmed cases rates does not necessarily lead to a a higher cumulative death cases rates.

# 12. References
- Anselin, L. (2020, September 15). Basic mapping. GeoDa on Github. Retrieved from: https://geodacenter.github.io/workbook/3a_mapping/lab3a.html

- Anselin, L. (2018, August 3). Maps for rates or proportions. GeoDa on Github.  Retrieved from: https://geodacenter.github.io/workbook/3b_rates/lab3b.html

- Gimond, M. (2021, September 07). E mapping rates in R | Intro to GIS and spatial analysis. Main repos | mgimond.github.io. Retrieved from: https://mgimond.github.io/Spatial/mapping-rates-in-r.html#raw-rates

- Lovelace, R., Nowosad, J., & Muenchow, J. (n.d.). Chapter 8 making maps with R. Welcome | Geocomputation with R. Retrieved from: https://geocompr.robinlovelace.net/adv-map.html

- Situation report #5: COVID-19 pandemic - 24th March 2020 - Indonesia. (24 March 2020). ReliefWeb. Retrieved from: https://reliefweb.int/report/indonesia/situation-report-5-covid-19-pandemic-24th-march-2020

- Tin Seong.K (2021, August 30) In-class Exercise 3: Analytical Mapping. Retrieved from: https://is415.netlify.app/in-class_ex/in-class_ex03/in-class_ex03#1

